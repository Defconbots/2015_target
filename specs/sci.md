# 2015 Target Serial Command Interface 

## Scope

This document will describe the interfaces used to communicate with the 2015 target system, including the central train controller and the individual targets. The goal is to design a simple and human-readable serial interface that can be used to debug target hardware as well as interface the hardware to an application on an PC.

## Overview

The 2015 target system has three main components: The command PC, the central train controller and the targets. To communicate with the train controller we use a virtual serial port hosted over a 2.4ghz zigbee radio. Internal to the train the train controller uses a secondary serial protocol to command/query individual targets. Both serial interfaces use a 115200 baud 8N1 RS232 protocol.

External to the targets are contestants with their serial-laser interface. Contestants will use 50mW green laser pointers with 4800 baud 8N1 RS232 data encoded in the laser.

                                               >Target-1<
                                               >Target-2<
    PC <-zigbee rf-> Train-Controller <-Serial->Target-3<-Laser-< Contestant-Robot
                                               >Target-4<
                                               >Target-5<

In this configuration we will assume that between the PC and train controller the PC is the master -- meaning commands are always issued from the PC and a response is always generated by the train controller. Between the train controller and targets we assume the train controller is the master -- meaning commands are always issued from the train controller and a response is always generated by the target it is addressing. TL;DR: PC is master to the train, train is master to the targets.

Every command or response between two devices will have specific start and stop bytes that indicate the type of packet or specific error code.

### Commands

There are two commands that can be used query data or initiate actions: Read and write.

|Command|Start Byte|Stop Byte|
|:-----:|:--------:|:-------:|
|Read   |'{'       |'}'      |
|Write  |'['       |']'      |

### Responses

Each command will generate one of three possible responses: A read response, a write response, or an error.

|Response      |Start Byte|Stop Byte|
|:------------:|:--------:|:-------:|
|Read Response |'('       |')'      |
|Write Response|'<'       |'>'      |
|Error         |'W'       |'F'      |

## Command/Response Definitions

### Read

|Offset|Component|
|:----:|:-------:|
|  0   |'{'      |
|  1   |ADDRESS  |
|  2   |DEVICE   |
|  3   |'}'      |

### Read Response

|Offset|Component|
|:----:|:-------:|
|  0   |'('      |
|  1   |DATA_H   |
|  2   |DATA_L   |
|  3   |')'      |

### Write

|Offset|Component|
|:----:|:-------:|
|  0   |'['      |
|  1   |ADDRESS  |
|  2   |DEVICE   |
|  3   |DATA_H   |
|  4   |DATA_L   |
|  5   |']'      |

### Write Response

|Offset|Component|
|:----:|:-------:|
|  0   |'<'      |
|  1   |ADDRESS  |
|  2   |'>'      |

### Error

|Offset|Component |
|:----:|:--------:|
|  0   |'W'       |
|  1   |ERROR_CODE|
|  2   |'F'       |

### Error Codes

|Code|Description          |
|:--:|:-------------------:|
| A  |Address Invalid      |
| T  |Device Invalid       |
| M  |Malformed Command    |

### Addresses and Devices

Every part of the train has an address from 0 and going to 5. To address all targets use '*' as the address.

|Address|Component  |
|:-----:|:---------:|
|   0   |Train      |
|   1   |Target #1  |
|   2   |Target #2  |
|   3   |Target #3  |
|   4   |Target #4  |
|   5   |Target #5  |
|   *   |All Targets|

### Devices

There are specific pieces of hardware that can be queried at each address -- we call these devices.

|Device ID|Description     |Address Where Available|Read/Write?|
|:-------:|:--------------:|:---------------------:|:---------:|
|    V    |Voltage(Battery)|           0           |     R     |
|    S    |Speed(Train)    |           0           |    R/W    |
|    R    |Red LED Status  |          1-5          |    R/W    |
|    B    |Blue LED Status |          1-5          |    R/W    |
|    I    |ID(Hit)         |          1-5          |    R/W    |

### Device Definitions

#### V - Voltage (Train Battery) - Read Only

Returns the battery voltage of the train controller in hundreds of millivolts (100mV). The practical range of this output is 00 to 55 (0-5.5VDC).

#### S - Speed (Train) - Read/Write

There are four possible train speed settings: slow astern, stop, half ahead, and full ahead.

|Code|Setting    |
|:--:|:---------:|
| R1 |Slow Astern|
| ST |Stop       |
| F1 |Half ahead |
| F2 |Full ahead |

Returns the current train speed when read. Writing to this device will set the current train speed.

#### R - Red LED Status (Target) - Read/Write

Returns the current red LED status of the addressed target when read. Writing a 0 to this device will disable the LED. Writing non-0 to this device will enable the LED.

#### B - Blue LED Status (Target) - Read/Write

Returns the current blue LED status of the addressed target when read. Writing a 0 to this device will disable the LED. Writing non-0 to this device will enable the LED.

#### I - ID (Target Hit) - Read/Write

Targets can detect hits from the ID encoded in contestant's laser. When a contestant hits a target the ID will latch into the target hit ID device. When read, this will return the hit ID stored. Writing to this device will set it to the value passed. This command is unique in that contestants, via their laser serial interface, can write to this device.

### Example Commands/Responses

#### Read Train Battery Voltage + Response

    {0V}(41)

Battery voltage reported as 4.1VDC.

#### Read/Write Train Speed + Response

    {0S}(F1)

Train speed reported to be half-ahead.

    [0SST]<0>

Train speed set to stop.

#### Read/Write Red LED + Response

    {1R}(01)

Target #1 Red LED status reported to be enabled.

    [1R00]<1>

Target #1 Red LED set to disabled.

#### Read/Write Hit ID + Response

    {5I}(08)

Target #5 hit ID reported to be 08.

    [5I00]<5>

Target #5 hit ID reset to 0.

    [*I08]

Write ID '08' to a target. This can only be accessed via the laser serial interface and has no response.

#### Read/Write Erroneous Data + Response

    {0I}WTF

Read to invalid device reports a device error (train has no hit ID).

    {9R}WAF

Read to invalid address reports an address error (there is no target #9).

